# Overview
AKA Robust Security Network

- An improvement over [[WLAN]]
	- Adds [[Authentication]], [[Access Control]], and [[Message Integrity]]
	- Uses an authentication server (similar to the [[Kerberos]] system) to mutually authenticate the station and AP
	- Generates *temporary* [[Cryptography|keys]]

See first:
- [[WLAN]]

# Phases
1. [[#Discovery phase]]
2. [[#Authentication phase]]
3. [[#Key management phase]]
4. [[#Protected data transfer phase]]
5. [[#Connection termination]]

## Discovery phase
- The AP uses "beacons" and "probe responses" to advertise its security policy
	- These messages are used by a station to find an AP to associate with
- Negotiates security algorithms
	- Confidentiality and MPDU integrity protocols for unicast traffic
		- For broadcast traffic, the AP gets to decide because all the stations have to use the same protocols and ciphers for broadcasting to work
			- If this wasn't the case, some stations would understand and others wouldn't
	- Authentication method
	- Cryptography key management strategy

Stages:
1. Network and security discovery
	- A station discovers the network either by hearing a beacon or responding to a probe
2. Open system authentication
	- Exchange identifiers
3. Association
	- Agreeing on a set of security capabilities
	- Practically, this means a station picking a set of capabilities from the beacon

## Authentication phase
- The station and AS prove their identities
	- Messages are forwarded via the AP
	- Non-authentication traffic is blocked until complete
		- The [[WLAN#MPDU|control channel]] is allowed but the data channel in the MPDU is blocked
- Provides mutual authentication between the station and a DS' authentication server
- Provides the guarantee that only authorised stations are using the network --> the station knows it's communicating with a legitimate network
- Uses [[EAP]]

Stages:
1. Connect to AS
	- The station sends a request to the AP
	- The AP sends a request to the AS and sends an acknowledgement back to the station
2. Perform [[EAP]] exchange
	- Mutually authenticates the station and AS
3. Deliver keys
	- The AS generates an AAAK (Authentication, Authorisation, Accounting Key) and sends it to the station
	- The keys required for communication between the station and AS are derieved from the AAAK
### Ports
- An AP has two physical ports:
	- A connection to the DS
	- A wireless connection for within the BSS
- There are two types of logical ports:
	- Uncontrolled: allows MPDUs between a station and the AS irrespective of authentication status
	- Controlled: allows MPDUs between a station and other systems in the LAN if the station has been authenticated
- Logic ports are mapped onto one of these physical ports

## Key management phase
- Keys are generated from the AAAK
- Lots of [[Cryptography|keys]] generated, falling into two categories:
	- Pairwise: for communicating between stations and the AP
	- Group: for multicast communications
		- Generated by the AP and distributed to all stations in a multicast group
- These keys are generated using the [[#4-way handshake]]

### Pairwise keys
- The AAAK or some pre-shared key is used as the master key
- The pairwise primary key is derived from the master key
	- If the master key is an AAAK, it is truncated to get the pairwise primary key
	- If using a pre-shared key, that's used as the primary key
- The pairwise transient key is derived from the primary key
	- Creates 3 keys that will be used for communication after authentication

### Group keys
- A hierarchy of keys
	- The group master key is at the top
- The AP generates a group temporal key from the group master key
- The group temporal key is distributed to all stations using the pairwise keys
	- This key is changed whenever a device leaves the network

### 4-way handshake
AKA the pairwise key distribution

- Used to:
	- Say that the pairwise primary key exists
	- Verify the cipher suite selection
	- Derive a new pairwise transient key for the session

Steps:
1. The AP sends a message to the station with the AP's [[MAC Addresses|MAC address]] and a [[Nonce]] $Anonce$
2. The station generates a nonce $Snonce$, then uses both nonces and MAC addresses and the pairwise primary key to generate a pairwise transient key
	1. The station sends a message with its MAC address and $Snonce$ to the AP. Also has a [[Message Integrity|MAC]] encrypted with the first 128 bits of the pairwise transient key
3. The AP generates the same pairwise transient key using both nonces and MAC addresses
	1. The [[Message Integrity|MAC]] is verified
	2. The AP sends a message to the station with the AP's MAC address and $Anonce$ (again) plus a [[Message Integrity|MAC]]
4. The station verifies the [[Message Integrity|MAC]] and sends an acknowledgement (protected with another [[Message Integrity|MAC]])

### Group key distribution
 1. The AP sends a message to the station including the group temporal key (encrypted with RC4 or [[Advanced Encryption Standard|AES]])
	 1. The key used for encryption is the second 128 bits of the pairwise transient key
	 2. A [[Message Integrity|MAC]] is appended
 2. The station verifies the [[Message Integrity|MAC]] and decrypts the group temporal key. The station acknowledges with another [[Message Integrity|MAC]]

## Protected data transfer phase
- Station-to-station transmission can now occur
- Note: security is only provided between the origin station and the AP
	- If the stations are in the same network, this will be secure
	- If the stations are in an ESS, there will be security within *each* BSS but not in the DS --> not secure station-to-station
	- If the destination station is on a wired network, only origin station --> AP is secured
- There are two schemes that might be used:
	- TKIP (Temporal Key Integrity Protocol)
		- Uses [[Message Integrity|MAC]]s for message integrity
		- MPDUs + MAC are encrypted with RC4 for message confidentiality
	- CCMP (Counter Mode-CBC MAC Protocol)
		- Uses [[Message Integrity#CBC-MAC|CBC-MAC]]s for message integrity
		- The MPDU + MAC are encrypted with [[Advanced Encryption Standard]] in [[Symmetric Cryptography#Counter mode|CTR mode]]
- For either scheme, the keys are formed from the last part of the pairwise transient key
- The schemes use non-repeating numbers in the MPDUs to stop replay attacks

## Connection termination
- The connection is destroyed